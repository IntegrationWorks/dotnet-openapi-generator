on: 
  workflow_dispatch:
    inputs:
      api_spec_repo:
        description: "API spec repository"
        required: true
      api_spec_path:
        description: "The path to the api spec"
        required: true
      target_repo:
        description: "The output repository"
        required: true
      target_path:
        description: "The path of the models folder"
        required: true
      namespace_name:
        description: "The the C# namespace to use for the models"
    secrets:
      iw_github_container_token:
        description: "A token with read/write permissions for the output repository"
        required: true

jobs:
  generate-models:
    runs-on: "ubuntu-latest"
    steps:
      - name: "Checkout Repo"
        uses: "actions/checkout@v4"
        with:
          repository: "${{ github.event.inputs.api_spec_repo }}"
          path: "./spec"
          token: "${{ secrets.iw_github_container_token }}"
      
      - name: "Checkout Repo"
        uses: "actions/checkout@v4"
        with:
          repository: "${{ github.event.inputs.target_repo }}"
          path: "./app"
          token: "${{ secrets.iw_github_container_token }}"
        
      - name: "Setup JDK 11"
        uses: "actions/setup-java@v1"
        with:
          java-version: 11

      - name: "Generate .NET Model Classes"
        run: |
          wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.4.0/openapi-generator-cli-7.4.0.jar -O openapi-generator-cli.jar
          java -jar ./openapi-generator-cli.jar generate -i ./spec/${{ github.event.inputs.api_spec_path }} -g csharp -o ./out -p packageName=${{ github.event.inputs.namespace_name }}
          
          mkdir -p ./app/${{ github.event.inputs.target_path }}
          cp ./out/src/${{ github.event.inputs.namespace_name }}/Model/* ./app/${{ github.event.inputs.target_path }}
          cd ./app

          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add .
          git commit -m "Generate and add models."
          git push
